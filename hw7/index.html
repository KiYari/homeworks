<html lang="ru">
	<head>
	<title>JS Game</title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
	<link rel="stylesheet" href="style.css">
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mootools/1.6.0/mootools-core.js"></script>
	<style type="text/css">
		canvas { border: 1px solid white; }
	</style>

	</head>

	<body onload="init();" class="bg-dark">
	<div class="buttons align-center">
			<h2 class="points">ОЧКИ</h2>
			<h3 class="exp" id="exp"></h3>
			<input class="btn btn-success" id="start" onclick="start()" type="button" class="btn" value="Старт">
			<input class="btn btn-success" type="button" onclick="pause()" class="btn" value="Пауза">
			<input class="btn btn-success" type="button" class="btn" onclick="restart()" value="Рестарт">
			<a href="#table"><input class="btn btn-success" type="button" class="btn" onclick="display_table()" value="Рейтинг"></a>
			<input class="btn btn-success" type="button" class="btn" value="Сменить пользователя" onclick="change_name()">
		</div>
		<canvas id="canvas" width="1024" height="524" onclick="goInput(event);" onmousemove="rotate_cannon(event);">\
		</canvas>
		<div id="table" class="table text-white tbl" align="center"></div>
		<script>

			let cannon, x, y, cores_angle, cannon_angle, x_cannon, y_cannon;
			let START = 0;
			let reload;
			let gun_cores = [];
			let hp = 3;
			let idTimer;
			let level = 1;
			let exp_points;
			let name;

			function getRandomInt(min, max) {
				min = Math.ceil(min);
				max = Math.floor(max);
				return Math.floor(Math.random() * (max - min + 1)) + min;
			}

			function rad(n) {
				return n * Math.PI / 180;
			}
			// hp
			let heart = new Image();
			heart.src = 'img/heart.png';
			// Основной фон
			let mainBg = new Image(canvas.width, canvas.height);
			mainBg.src = 'img/testbg.png';
			// Противники
			let knight = new Image();
			knight.src = 'img/knight.png';
			let bird = new Image();
			bird.src = 'img/bird.png';
			let horse = new Image();
			horse.src  = 'img/horse.png';

			let enemies_type;
			let enemy1 = [100, 0.5, knight, 200];
			let enemy2 = [300, 0.8, bird, 170]
			let enemy3 = [120, 0.6, horse, 250];


			// Инициализация игры
			function init(){
				canvas = document.getElementById('canvas');
				if (canvas.getContext) {

					reload = 150; // Перезарядка

					cores_angle = rad(60); // Углы снаряда и пушки
					cannon_angle = rad(60);

					START = 0;

					x_cannon = 50; // Пушка
					y_cannon = canvas.height - 45;
					cannon = new Cannon;
					gun_cores = [];

					enemies = []; // Противники
					exp_points = 0;
					enemies_type = [enemy1, enemy2, enemy3];

					ctx = canvas.getContext('2d');
					x = canvas.getBoundingClientRect().left;
					y = canvas.getBoundingClientRect().top;
					getName();
					drawBack(ctx, canvas.width, canvas.height);
				}
			}

			function drawBack(ctx) {
				ctx.clearRect(0, 0, canvas.width, canvas.height);
				ctx.drawImage(mainBg, 0, 0, canvas.width, canvas.height);
				cannon.draw(ctx);
				for (let i = 0; i < gun_cores.length; i++) {
					gun_cores[i].draw(ctx);
				}
				for (let i = 0; i < enemies.length; i++) {
					enemies[i].draw(ctx);
				}
				collusion();
				if (reload < 201) {
					reload++;
				}
				progressBar(ctx);
				info(ctx);
			}
			// Пушка
			Cannon = new Class({
				draw: function (ctx) {
					with (this) {
						ctx.save()
						ctx.translate(x_cannon, y_cannon);
						ctx.rotate(cannon_angle);
						ctx.fillStyle = '#575454';
						ctx.beginPath();
						ctx.arc(7.5, 15, 18.5, 2 * Math.PI, Math.PI, false);
						ctx.moveTo(-10, 20);
						ctx.lineTo(-10, -60);
						ctx.lineTo(13, -60);
						ctx.lineTo(26, 20);
						ctx.lineTo(-10, 20);
						ctx.fill();
						ctx.closePath();
						ctx.restore()
						ctx.save();

						ctx.fillStyle = '#acadac';
						ctx.beginPath();
						ctx.arc(x_cannon + 10, y_cannon + 25, 20, Math.PI, Math.PI + 10, false);
						ctx.fill();
						ctx.closePath();
						ctx.fill();
						ctx.restore();
						ctx.save();
						ctx.strokeStyle = '#443104';
						ctx.beginPath();
						ctx.arc(x_cannon + 10, y_cannon + 25, 20, Math.PI, Math.PI + 10, false);
						ctx.stroke();
						ctx.closePath();
						ctx.restore();
					}
				}
			})
			// Снаряды
			GunCore = new Class({
				initialize: function (angle) {
					this.posX = 0;
					this.posY = 0;
					this.speed = 12;
					this.angle = angle
					this.size = 12;
				},
				draw: function (ctx) {
					ctx.fillStyle = '#575454';
					ctx.save();
					ctx.translate(x_cannon, y_cannon);
					ctx.beginPath();
					ctx.arc(this.posX, -this.posY, this.size, 0, 2 * Math.PI, false);
					ctx.closePath();
					ctx.fill();
					ctx.restore();
					this.physics();
				},
				physics: function () {
					this.posY = this.posX * Math.tan(this.angle) - (0.15 * (this.posX ** 2) /
							(2 * (this.speed ** 2) * (Math.cos(this.angle) ** 2)));
					this.posX += this.speed * Math.cos(this.angle) / 5;
				}
			})
			// Враги
			Enemies = new Class({
				initialize: function (pX, pY, speed, img, size) {
					this.posX = pX;
					this.posY = pY;
					this.speed = speed;
					this.img = img
					this.size = size;
				},
				draw: function (ctx) {
					ctx.drawImage(this.img, this.posX - this.size / 2, canvas.height - this.posY - this.size / 2,
							this.size, this.size);

				},
				getPoints: function () {
					return this.size / 10;
				}
			})

			function get_enemy(step) {
				let type = getRandomInt(0, 2);
				let enemy = new Enemies(canvas.width + step, enemies_type[type][0],
						enemies_type[type][1], enemies_type[type][2], enemies_type[type][3]);
				enemies.push(enemy);
			}


			// Стрельба
			function goInput(){
				if (START === 1 && reload >= 150 ) {
					let core = new GunCore(cores_angle);
					gun_cores.push(core);
					reload = exp_points / 1000;
				}
			}
			function rotate_cannon(event) {
				if (START === 1) {
					let x1 = event.x - x - x_cannon;
					let y1 = canvas.height + y - event.y - 50;
					if (x1 >= 0 && y1 >= 0 ){
						cores_angle = Math.atan2(y1, x1);
						cannon_angle = Math.atan2(x1, y1);
					}
				}
			}

			// Перезарядка
			function progressBar(ctx) {
				ctx.save();
				ctx.translate(x_cannon - 45, y_cannon + 30);
				ctx.fillStyle = 'green';
				ctx.beginPath();
				ctx.fillRect(0, 0, 10, -( reload / 3));
				ctx.fill();
				ctx.restore();
				ctx.save();
			}

			function collusion() {
				for (let i = 0; i < gun_cores.length; i++) {
					if (gun_cores[i].posX > canvas.width ||  gun_cores[i].posY > canvas.height) {
						gun_cores.splice(i, 1)
					}
				}
			}


			// Начало игры
			function start() {

				if (START === 1) {
					clearInterval(idTimer);
				}
				START = 1;
				idTimer = setInterval('gameLoop()', 1);
			}


			function gameLoop() {
				if (hp > 0) {
					drawBack(ctx);
					let step = 0;
					level = exp_points / 500 + 1;
					let enemy_amount = 3 + level * 2;
					for (let i = 0; i < gun_cores.length; i++) {
						for (let j = 0; j < enemies.length; j++) {
							if (gun_cores[i] && enemies[j]) {
								if (kill(gun_cores[i], enemies[j])) {
									exp_points += enemies[j].getPoints();
									enemies.splice(j, 1);
									gun_cores.splice(i, 1);
								}
							}
						}
					}
					for (let i = 0; i < enemies.length; i++) {
						if (enemies[i].posX <= 140) {
							enemies.splice(i, 1)
							hp--;
						}
					}
					// Движение врагов
					for (let i = 0; i < enemies.length; i++) {
						enemies[i].posX -= enemies[i].speed + exp_points / 1500;
					}

					while (enemies.length < enemy_amount) {
						get_enemy(step);
						step += 150;
					}
				}
				else {
					end_game();
				}
			}
			function kill(figure1, figure2) {
				let clashX = false;
				let clashY = false;
				if (figure1.posX - figure2.size / 2 <= figure2.posX && figure1.posX + figure2.size / 2 >= figure2.posX) clashX = true;
				if (figure1.posY - figure2.size / 2 <= figure2.posY && figure1.posY + figure2.size / 2 >= figure2.posY) clashY = true;
				return clashX && clashY
			}
			// Хп и опыт
			function info(ctx) {
				document.getElementById("exp").innerHTML = exp_points;
				let step_hp = 0;
				for (let i = 0; i < hp; i++) {
					ctx.drawImage(heart, 10 + step_hp, 30, 50, 50);
					step_hp += 40;
				}
			}
			function getName() {
				name = prompt('Как Вас зовут?');
				if (name === '') {
					getName();
				}
			}

			function pause() {
				clearInterval(idTimer);
				START = 0;
			}
			function restart() {
				clearInterval(idTimer);
				discharge();
				start();
			}

			function discharge() {
				level = 1;
				hp = 3;
				START = 0
				exp_points = 0;
				gun_cores = [];
				enemies = [];
				reload = 150;
				drawBack(ctx);
			}

			function end_game() {
				alert("GAME OVER");
				localStorage.setItem(name, exp_points);
				clearInterval(idTimer);
				discharge();
				display_table();
			}
			// Таблица
			function display_table() {
				let elements = [];
				for (let i = 0; i<localStorage.length; i++){
					let key = localStorage.key(i);
					elements.push([localStorage.getItem(key), key]);
				}
				elements = elements.sort(function (a, b) {
					return parseInt(a, 10) - parseInt(b, 10);
				}).reverse();
				let html = "<table id=\"gen\"><th>ИМЯ</th><th>ОЧКИ</th>";
				for (let i = 0; i < localStorage.length && i < 15; i++) {
					html += "<tr aling=\"center\">";
					for (let j = 0; j < 1; j++) {
						html += "<td>" + elements[i][1] + "</td>";
						html += "<td>" + elements[i][0] + "</td>"
					}
					html += "</tr>";
				}
				html += "</table>";

				document.getElementById("table").innerHTML = html;
			}

			// Смена имени
			function change_name() {
				localStorage.setItem(name, exp_points);
				discharge();
				getName();
			}
			
		</script>
		<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
	</body>
</html>
